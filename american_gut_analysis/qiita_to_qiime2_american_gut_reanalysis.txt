#Qiime2 analysis including exporting from qiita
#Updated 10/7/20


#Transferring qiita artifacts to Qiime 2 Website Link: https://forum.qiime2.org/t/transferring-qiita-artifacts-to-qiime2/4790
#Combine the studies into a deblur table in qiita and then rarefy the table to 10,000 reads, use download the rarefied biom table, rarefied feature qza, and rooted tre (after you have rarefied in qiita) to the appropriate dropbox folder, from there follow the commands below to create qiime2 biom, tre, and representative seqs files, the rep seq file will be made from the rarefied biom table you outputted from qiita

#update to most current version of qiime2
#uninstall 2020.2 and replace with 2020.8

conda env remove -n qiime2-2020.2

source activate qiime2-2020.8

#########################################################################
####Obtain feature table and representative sequences####

#Filter samples out of feature table
#You created another metadata text file "filtered" where you removed chimp17 and all non-USA humans

qiime feature-table filter-samples \
  --i-table primate_micro_allsamples_rarefied_table.qza \
  --m-metadata-file primate_micro_filtered_metadata.txt \
  --o-filtered-table primate_micro_filtered_rarefied_table.qza
  
qiime feature-table filter-samples \
  --i-table primate_micro_allsamples_table.qza \
  --m-metadata-file primate_micro_filtered_chimp17included_metadata.txt \
  --o-filtered-table primate_micro_filtered_unrarefied_table.qza
 
 
  
#Representative sequences
#Must generate from the unfiltered Biom Table, but then you can filter the sequences with the feature table

biom summarize-table --observations -i primate_micro_unrarefied_all_samples.biom \
| tail -n +16 | awk -F ':' '{print ">"$1"\n"$1}' > primate_micro_allsamples_unrarefied_rep_seqs.fna

qiime tools import --input-path primate_micro_allsamples_unrarefied_rep_seqs.fna --type 'FeatureData[Sequence]' --output-path primate_micro_allsamples_unrarefied_rep_seqs.qza

qiime feature-table filter-seqs --i-data primate_micro_allsamples_unrarefied_rep_seqs.qza --i-table primate_micro_filtered_unrarefied_table.qza --o-filtered-data primate_micro_filtered_unrarefied_rep_seqs.qza

#Representative sequences
#Must generate from the unfiltered Biom Table, but then you can filter the sequences with the feature table

biom summarize-table --observations -i primate_micro_allsamples_rarefied_table.biom \
| tail -n +16 | awk -F ':' '{print ">"$1"\n"$1}' > primate_micro_allsamples_rep_seqs.fna

qiime tools import --input-path primate_micro_allsamples_rep_seqs.fna --type 'FeatureData[Sequence]' --output-path primate_micro_allsamples_rep_seqs.qza

qiime feature-table filter-seqs --i-data primate_micro_allsamples_rep_seqs.qza --i-table primate_micro_filtered_rarefied_table.qza --o-filtered-data primate_micro_filtered_rep_seqs.qza
 

############################################################################
####Assign taxonomy####

#use a classifier that has been pretrained on GreenGenes database with 99% OTUs and put it into appropriate folder

qiime feature-classifier classify-sklearn --i-reads primate_micro_filtered_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_primate_micro_rarefied.qza

qiime metadata tabulate \
  --m-input-file taxonomy_assignment_primate_micro_rarefied.qza \
  --o-visualization taxonomy_assignment_primate_micro_rarefied.qzv
  
#use a classifier that has been pretrained on GreenGenes database with 99% OTUs and put it into appropriate folder

qiime feature-classifier classify-sklearn --i-reads primate_micro_filtered_unrarefied_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_primate_micro_unrarefied.qza

qiime metadata tabulate \
  --m-input-file taxonomy_assignment_primate_micro_unrarefied.qza \
  --o-visualization taxonomy_assignment_primate_micro_unrarefied.qzv

############################################################################
####Run the combined ASV table through the jupyter notes pipeline to split them into genus specific tables####

#################################################################
####Filter out genera with NAs###

#set variables for input and output folder!
#move into the the folder that contains the input directory
#have to drag and drop the path for the input

input=/Users/jenniferhoutz/Dropbox/moeller_rotation/manuscript_analysis/genus_otu_tables

output=filtered

cd $inputpath

#cd back into the input folder

#Create the output directory

# Find the part of the name that changes and save it to a file. 

ls *.qza > $output/filenames.txt

#now copy metadata file into original folder NOT the new output folder

#filter out those families with NAs

while read line; do qiime feature-table filter-samples --i-table $line --m-metadata-file primate_micro_filtered_metadata.txt --p-min-frequency 1 --o-filtered-table $output/${line}; done < $output/filenames.txt

#################################################################
####Conduct Dice beta diversity####
#Repeat the input/output directories but for the next step

input=/Users/jenniferhoutz/Dropbox/moeller_rotation/manuscript_analysis/genus_otu_tables/filtered

output=dice

cd $inputpath

#cd back into the input folder

#Create the output directory

# Find the part of the name that changes and save it to a file. 

ls *.qza > $output/filenames.txt

#now copy metadata file into input folder NOT the new output folder

#Loop through all filenames and export them. 

#Sorensen-dice 

while read line; do qiime diversity beta --i-table $line --p-metric dice --o-distance-matrix $output/${line}; done < $output/filenames.txt

#################################################################	
####Beta group significance test using the species_geo_captivity metadata category####
#Repeat the input/output directories but for the next step

input=/Users/jenniferhoutz/Dropbox/moeller_rotation/manuscript_analysis/genus_otu_tables/filtered/dice

output=species_geo_captivity

cd $inputpath

#cd back into the input folder

#Create the output directory

# Find the part of the name that changes and save it to a file. 

ls *.qza > $output/filenames.txt

#now copy metadata file into input folder NOT the new output folder

#now we have to calculate beta group significance for each diversity metric

#dice beta significance

while read line; do qiime diversity beta-group-significance --i-distance-matrix $line --m-metadata-file primate_micro_filtered_metadata.txt --m-metadata-column species_geo_captivity --o-visualization $output/${line} --p-pairwise; done < $output/filenames.txt

#################################################################
####Unzip the qzvs to get the raw data files#####

#move into the the folder that contains the input directory
#have to drag and drop the path for the input

#Repeat the input/output directories but for the next step

input=/Users/jenniferhoutz/Dropbox/moeller_rotation/manuscript_analysis/genus_otu_tables/filtered/dice/species_geo_captivity

output=unzipped_qzvs

cd $inputpath

#cd back into the input folder

#Create the output directory

# Find the part of the name that changes and save it to a file. 

ls *.qzv > $output/filenames.txt

#unzip the qzas
#the raw data for the dice comparisons are in the species named folders as rawdata text files
#Rename them for each genus and put them into a new folder

while read line; do qiime tools export --input-path $line --output-path $output/${line}; done < $output/filenames.txt

##################################################################
#####PCOA####

qiime diversity beta --i-table primate_micro_filtered_rarefied_table.qza --p-metric dice --o-distance-matrix dice_primate_micro_filtered_rarefied_table.qza

#PCoA for dice

qiime diversity pcoa \
	--i-distance-matrix dice_primate_micro_filtered_rarefied_table.qza \
	--o-pcoa pcoa_dice_primate_micro_filtered_rarefied_table.qza
	
qiime emperor plot \
  --i-pcoa pcoa_dice_primate_micro_filtered_rarefied_table.qza \
  --m-metadata-file primate_micro_filtered_metadata.txt \
  --o-visualization pcoa_dice_primate_micro_filtered_rarefied_table.qzv


####Alpha Diversity####

#Shannon

qiime diversity alpha \
  --i-table primate_micro_filtered_rarefied_table.qza \
  --p-metric shannon \
  --o-alpha-diversity shannon_primate_micro_vector.qza

qiime diversity alpha-group-significance --i-alpha-diversity shannon_primate_micro_vector.qza --m-metadata-file primate_micro_filtered_metadata.txt --o-visualization shannon_primate_micro_group_significance.qzv

#chao1

qiime diversity alpha \
  --i-table primate_micro_filtered_rarefied_table.qza \
  --p-metric chao1 \
  --o-alpha-diversity chao1_primate_micro_vector.qza

qiime diversity alpha-group-significance --i-alpha-diversity chao1_primate_micro_vector.qza --m-metadata-file primate_micro_filtered_metadata.txt --o-visualization chao1_primate_micro_group_significance.qzv










#####Howlers#####

#Split the table into two based on host species with humans included

#Howlers and humans (all) (host_scientific_name with Homo sapiens and Alouatta palliata)

qiime feature-table filter-samples --i-table clayton_rarefied_feature_table.qza --m-metadata-file clayton_metadata_mapping_file.txt --p-where "host_scientific_name IN ('Homo sapiens', 'Alouatta palliata')" --o-filtered-table howler_humansall_table.qza
  
#We will compare the howlers (all from Costa Rica) with two human populations from the USA and Venezuela
#First we will do the USA human population
#Now remove all humans NOT from the USA (geo_loc_name with USA and CRI (Costa Rica for howlers)

qiime feature-table filter-samples --i-table howler_humansall_table.qza --m-metadata-file clayton_metadata_mapping_file.txt --p-where "geo_loc_name IN ('USA', 'CRI')" --o-filtered-table howler_humansUSA_table.qza
















#Doucs and humans (all) (host_scientific_name with Homo sapiens and Pygathrix nemaeus)

qiime feature-table filter-samples --i-table clayton_rarefied_feature_table.qza --m-metadata-file clayton_metadata_mapping_file.txt --p-where "host_scientific_name IN ('Homo sapiens', 'Pygathrix nemaeus')" --o-filtered-table douc_humansall_table.qza
  
#There are two captive douc populations so you need to make two tables, the wild and semi-captive pops are from VNM 

#1) USA doucs: Now remove all humans NOT from the USA and doucs from SGP (geo_loc_name with USA, SGP, and VNM (USA and Vietnam for doucs)

qiime feature-table filter-samples --i-table douc_humansall_table.qza --m-metadata-file clayton_metadata_mapping_file.txt --p-where "geo_loc_name IN ('USA', 'VNM')" --o-filtered-table doucsUSA_humansUSA_table.qza

#2) SGP doucs: Now remove all humans NOT from the USA and doucs from USA (geo_loc_name with USA, SGP, and VNM (Singapore and Vietnam for doucs)

qiime feature-table filter-samples --i-table douc_humansall_table.qza --m-metadata-file doucsSGP_humansUSA_samples_to_keep.txt  --o-filtered-table doucsSGP_humansUSA_table.qza

#Now we will calculate Sorensen-Dice beta diversity for each table

	#Howler and USA humans

qiime diversity beta --i-table howler_humansUSA_table.qza --p-metric dice --o-distance-matrix dice_howlers_humansUSA.qza

	#USA doucs and USA humans

qiime diversity beta --i-table doucsUSA_humansUSA_table.qza --p-metric dice --o-distance-matrix dice_doucsUSA_humansUSA.qza

	#SGP doucs and USA humans

qiime diversity beta --i-table doucsSGP_humansUSA_table.qza --p-metric dice --o-distance-matrix dice_doucsSGP_humansUSA.qza

#Dice beta diversity significance (choose which metadata category to compare, if more than one host species you may have to filter by species into two separate tables)

#Compare by captivity state (captive_wild with options of Wild, Captive, Semi-captive, or human) 

	#Howler and USA humans

qiime diversity beta-group-significance --i-distance-matrix dice_howlers_humansUSA.qza --m-metadata-file clayton_metadata_mapping_file.txt --m-metadata-column captive_wild --o-visualization dice_beta_significance_captivity_howlers_humansUSA.qzv --p-pairwise

	#USA doucs and USA humans

qiime diversity beta-group-significance --i-distance-matrix dice_doucsUSA_humansUSA.qza --m-metadata-file clayton_metadata_mapping_file.txt --m-metadata-column captive_wild --o-visualization dice_beta_significance_captivity_doucsUSA_humansUSA.qzv --p-pairwise

	#SGP doucs and USA humans

qiime diversity beta-group-significance --i-distance-matrix dice_doucsSGP_humansUSA.qza --m-metadata-file clayton_metadata_mapping_file.txt --m-metadata-column captive_wild --o-visualization dice_beta_significance_captivity_doucsSGP_humansUSA.qzv --p-pairwise

#Assign taxonomy

#use a classifier that has been pretrained on GreenGenes database with 99% OTUs and put it into appropriate folder

wget -O "gg-13-8-99-515-806-nb-classifier.qza" "https://data.qiime2.org/2018.2/common/gg-13-8-99-515-806-nb-classifier.qza"

#assign taxonomy to each sequence
	
qiime feature-classifier classify-sklearn --i-reads clayton_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_clayton_allsamples.qza





#Calculate alpha and beta diversity measurements including alpha (shannon, Faith's PD, and evenness) and beta (weighted and unweighted unifrac, and Bray-Curtis)
#Do this for each species
	#Core metrics will produce qza and qzv for everything except Sorensen-Dice so this has to be calculated separately
	#Richness= presence/absence (qualitative)
	#Evenness= abundance (quantitative)
	#Phylogenetic tree-based= calculates the sum of the branch length covered by a sample
	#Alpha diversity definitions: Shannon= evenness and richness; Faith's= phylogenetic tree-based
	#Beta diversity definitions: Jaccard= presence/absence; Sorensen-Dice= presence/absence; Bray-Curtis=presence/absence and weighted by taxon abundance;
	 Weighted UniFrac= quantitative phylogenetic tree-based; Unweighted UniFrac= qualitative phylogenetic tree-based

#Howler

qiime diversity core-metrics-phylogenetic --i-phylogeny clayton_rarefied_insertion_tree.qza --i-table howler_table.qza --p-sampling-depth 10000 --m-metadata-file clayton_metadata_mapping_file.txt --output-dir howler_core_metrics_results

	#Sorensen-Dice beta diversity has to be calculated separately

qiime diversity beta --i-table howler_table.qza --p-metric dice --o-distance-matrix dice_beta_howler_clayton.qza

#alpha diversity significance
	
	#Faith's PD
	
qiime diversity alpha-group-significance --i-alpha-diversity howler_core_metrics_results/faith_pd_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization howler_core_metrics_results/faith_pd_group_significance.qzv
	
	#Evenness
	
qiime diversity alpha-group-significance --i-alpha-diversity howler_core_metrics_results/evenness_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization howler_core_metrics_results/evenness_group_significance.qzv
	
	#Shannon
	
qiime diversity alpha-group-significance --i-alpha-diversity howler_core_metrics_results/shannon_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization howler_core_metrics_results/shannon_group_significance.qzv

	
#Beta diversity significance (choose which metadata category to compare, if more than one host species you may have to filter by species into two separate tables)

#First we will compare by captivity state (captive_wild with options of Wild, Captive, or Semi-captive in howlers 

#Dice

qiime diversity beta-group-significance --i-distance-matrix dice_beta_howler_clayton.qza --m-metadata-file clayton_metadata_mapping_file.txt --m-metadata-column captive_wild --o-visualization dice_beta_significance_captivity_howler_clayton.qzv --p-pairwise
	
	#PCoA for dice

qiime diversity pcoa --i-distance-matrix dice_beta_howler_clayton.qza --o-pcoa dice_beta_howler_clayton_pcoa.qzv
	
qiime emperor plot \
  --i-pcoa dice_beta_howler_clayton_pcoa.qzv.qza \
  --m-metadata-file clayton_metadata_mapping_file.txt \
  --o-visualization dice_beta_howler_clayton_pcoa
  
#assign taxonomy to each sequence

qiime feature-classifier classify-sklearn --i-reads clayton_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_clayton.qza

qiime metadata tabulate --m-input-file taxonomy_assignment_clayton.qza --o-visualization taxonomy_assignment_clayton.qzv

#makes a taxa bar plot of the assigned taxonomy

qiime taxa barplot --i-table howler_table.qza --i-taxonomy taxonomy_assignment_clayton.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization taxa_bar_plot_howler_clayton.qzv

#Douc

qiime diversity core-metrics-phylogenetic --i-phylogeny clayton_rarefied_insertion_tree.qza --i-table douc_table.qza --p-sampling-depth 10000 --m-metadata-file clayton_metadata_mapping_file.txt --output-dir douc_core_metrics_results

	#Sorensen-Dice beta diversity has to be calculated separately

qiime diversity beta --i-table douc_table.qza --p-metric dice --o-distance-matrix dice_beta_douc_clayton.qza

#alpha diversity significance
	
	#Faith's PD
	
qiime diversity alpha-group-significance --i-alpha-diversity douc_core_metrics_results/faith_pd_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization douc_core_metrics_results/faith_pd_group_significance.qzv
	
	#Evenness
	
qiime diversity alpha-group-significance --i-alpha-diversity douc_core_metrics_results/evenness_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization douc_core_metrics_results/evenness_group_significance.qzv
	
	#Shannon
	
qiime diversity alpha-group-significance --i-alpha-diversity douc_core_metrics_results/shannon_vector.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization douc_core_metrics_results/shannon_group_significance.qzv

	
#Beta diversity significance (choose which metadata category to compare, if more than one host species you may have to filter by species into two separate tables)

#First we will compare by captivity state (captive_wild with options of Wild, Captive, or Semi-captive in howlers 

#Dice

qiime diversity beta-group-significance --i-distance-matrix dice_beta_douc_clayton.qza --m-metadata-file clayton_metadata_mapping_file.txt --m-metadata-column captive_wild --o-visualization dice_beta_significance_captivity_douc_clayton.qzv --p-pairwise
	
	#PCoA for dice

qiime diversity pcoa --i-distance-matrix dice_beta_douc_clayton.qza --o-pcoa dice_beta_douc_clayton_pcoa.qzv
	
qiime emperor plot \
  --i-pcoa dice_beta_douc_clayton_pcoa.qzv.qza \
  --m-metadata-file clayton_metadata_mapping_file.txt \
  --o-visualization dice_beta_douc_clayton_pcoa
  
#assign taxonomy to each sequence

qiime feature-classifier classify-sklearn --i-reads clayton_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_clayton.qza

qiime metadata tabulate --m-input-file taxonomy_assignment_clayton.qza --o-visualization taxonomy_assignment_clayton.qzv

#makes a taxa bar plot of the assigned taxonomy

qiime taxa barplot --i-table douc_table.qza --i-taxonomy taxonomy_assignment_clayton.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization taxa_bar_plot_douc_clayton.qzv

____  
  
#Bray-curtis
  
  qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column qiita_study_alias \
	--o-visualization bray-curtis-significance-folivorous-removed-qiita-study-alias.qzv \
	--p-pairwise
	
	#PCoA for bray curtis

qiime diversity pcoa \
	--i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
	--o-pcoa bray-curtis-beta-metrics-folivorous-removed-pcoa
	
qiime emperor plot \
  --i-pcoa bray-curtis-beta-metrics-folivorous-removed-pcoa.qza \
  --m-metadata-file metadata_excluding_folivorous.txt \
  --o-visualization bray-curtis-beta-metrics-folivorous-removed-pcoa.qzv

#Unweighted unifrac

qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column qiita_study_alias \
	--o-visualization unweighted-unifrac-significance-folivorous-removed-qiita-study-alias.qzv \
	--p-pairwise
	
	#PCoA for Unweighted unifrac

qiime diversity pcoa \
	--i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
	--o-pcoa unweighted-unifrac-beta-metrics-folivorous-removed-pcoa
	
qiime emperor plot \
  --i-pcoa unweighted-unifrac-beta-metrics-folivorous-removed-pcoa.qza \
  --m-metadata-file metadata_excluding_folivorous.txt \
  --o-visualization unweighted-unifrac-beta-metrics-folivorous-removed-pcoa.qzv
	
#Weighted unifrac

qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/weighted_unifrac_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column qiita_study_alias \
	--o-visualization weighted-unifrac-significance-folivorous-removed-qiita-study-alias.qzv \
	--p-pairwise
	
#PCoA for weighted unifrac

qiime diversity pcoa \
	--i-distance-matrix core-metrics-results/weighted_unifrac_distance_matrix.qza \
	--o-pcoa weighted-unifrac-beta-metrics-folivorous-removed-pcoa
	
qiime emperor plot \
  --i-pcoa weighted-unifrac-beta-metrics-folivorous-removed-pcoa.qza \
  --m-metadata-file metadata_excluding_folivorous.txt \
  --o-visualization weighted-unifrac-beta-metrics-folivorous-removed-pcoa.qzv
	
#second we will compare by rearing_history

#dice

qiime diversity beta-group-significance \
	--i-distance-matrix dice-beta-metrics-folivorous-removed.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column rearing_history \
	--o-visualization dice-beta-significance-folivorous-removed-rearing-history.qzv \
	--p-pairwise
	
  
#Pcoa-biplot for dice
#first we must create a relative-frequency table

qiime feature-table relative-frequency \
	--i-table id-filtered-folivorous-removed-table.qza \
	--o-relative-frequency-table relative-frequency-table-folivorous-removed

#now we apply the biplot

qiime diversity pcoa-biplot \
	--i-pcoa dice-beta-metrics-folivorous-removed-pcoa.qzv.qza \
	--i-features relative-frequency-table-folivorous-removed.qza \
	--o-biplot dice-folivorous-removed-biplot
	
qiime emperor biplot \
	--i-biplot dice-folivorous-removed-biplot.qza \
	--m-sample-metadata-file metadata_excluding_chimp17_changeinrearinghistory.txt \
	--o-visualization dice-beta-metrics-folivorous-removed-pcoa-biplot.qzv

#Bray-curtis

qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/bray_curtis_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column rearing_history \
	--o-visualization bray-curtis-significance-folivorous-removed-rearing-history.qzv \
	--p-pairwise

#Unweighted unifrac

qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column rearing_history \
	--o-visualization unweighted-unifrac-significance-folivorous-removed-rearing-history.qzv \
	--p-pairwise
	
#Weighted unifrac

qiime diversity beta-group-significance \
	--i-distance-matrix core-metrics-results/weighted_unifrac_distance_matrix.qza \
	--m-metadata-file metadata_excluding_folivorous.txt \
	--m-metadata-column rearing_history \
	--o-visualization weighted-unifrac-significance-folivorous-removed-rearing-history.qzv \
	--p-pairwise
	
#collapsing the taxonomy table to genus level (genus=6) 

qiime taxa collapse \
--i-table id-filtered-chimp17-removed-table.qza \
--i-taxonomy taxonomy_assignment_chimp17removed.qza \
--p-level 6 \
--o-collapsed-table genus_collapsed_table.qza

#collapsing the taxonomy table to family level (genus=5) 

qiime taxa collapse \
--i-table id-filtered-chimp17-removed-table.qza \
--i-taxonomy taxonomy_assignment_chimp17removed.qza \
--p-level 5 \
--o-collapsed-table family_collapsed_table.qza

#Assign taxonomy

#use a classifier that has been pretrained on GreenGenes database with 99% OTUs and put it into appropriate folder

wget -O "gg-13-8-99-515-806-nb-classifier.qza" "https://data.qiime2.org/2018.2/common/gg-13-8-99-515-806-nb-classifier.qza"

#assign taxonomy to each sequence

qiime feature-classifier classify-sklearn --i-reads clayton_rep_seqs.qza --i-classifier gg-13-8-99-515-806-nb-classifier.qza --o-classification taxonomy_assignment_howler_clayton.qza

qiime metadata tabulate --m-input-file taxonomy_assignment_howler_clayton.qza --o-visualization taxonomy_assignment_howler_clayton.qzv

#makes a taxa bar plot of the assigned taxonomy

qiime taxa barplot --i-table howler_table.qza --i-taxonomy taxonomy_assignment_howler_clayton.qza --m-metadata-file clayton_metadata_mapping_file.txt --o-visualization taxa_bar_plot_howler_clayton.qzv

#collapsing the taxonomy table to genus level (genus= 

qiime taxa collapse \
--i-table id-filtered-folivorous-removed-table.qza \
--i-taxonomy taxonomy_assignment_folivorous_removed.qza \
--p-level 5 \
--o-collapsed-table family_collapsed_table_folivorousremoved.qza
